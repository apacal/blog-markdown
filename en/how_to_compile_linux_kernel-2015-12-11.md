#How to compile custom linux kernel

## one clone linux kernel source code

clone repo
~~~
git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git
~~~
checkout what version that you want to compile
~~~
git tag
git checkout v2.6.12-rc2
git checkout -b v2.6.12-rc2
~~~


## two compile source code
install some tools
~~~
sudo apt-get install fakeroot build-essential kernel-package libncurses5 libncurses5-dev
~~~

copy your system boot config and ~~~make menuconfig~~~

~~~
make clean && make mrproper
cp /boot/config-`uname -r` ./.config
make menuconfig
~~~
select Load an Alternate Configuration File

### ext install gcc-2.95.3
download gcc-2.95.3-core.tar.gz and download patches
~~~
ftp://ftp.gnu.org/pub/gnu/gcc/
http://www.linuxfromscratch.org/patches/downloads/gcc/

~~~

patch patches
~~~
┌[apacal☮apacal-virtual-machine]-(~/gcc/gcc-2.95.3)
└> patch -Np1 -i ../gcc-2.95.3-2.patch
patching file gcc/c-common.c
patching file gcc/config/alpha/crtbegin.asm
patching file gcc/config/i386/i386.c
patching file gcc/config/i386/linux.h
patching file gcc/config/rs6000/rs6000.md
patching file gcc/config.in
patching file gcc/configure
patching file gcc/configure.in
patching file gcc/crtstuff.c
patching file gcc/cse.c
patching file gcc/cstamp-h.in
patching file gcc/function.c
patching file gcc/rtl.h
patching file gcc/rtlanal.c
patching file gcc/stor-layout.c
patching file gcc/toplev.c
patching file gcc/varasm.c
┌[apacal☮apacal-virtual-machine]-(~/gcc/gcc-2.95.3)
└> patch -Np1 -i ../gcc-2.95.3-no_fixinc-1.patch
patching file gcc/Makefile.in
┌[apacal☮apacal-virtual-machine]-(~/gcc/gcc-2.95.3)
└> patch -Np1 -i ../gcc-2.95.3-returntype_fix-1.patch
patching file gcc/toplev.c
┌[apacal☮apacal-virtual-machine]-(~/gcc/gcc-2.95.3)
└>
~~~

when ./configure some error happen

~~~
Invalid configuration `x86_64-unknown-linux-gnu': machine `x86_64-unknown' not recognized
~~~

~~~
┌[apacal☮apacal-virtual-machine]-(~/gcc/gcc-2-build)
└> cp /usr/share/libtool/config/config.guess ../gcc-2.95.3/
cp: overwrite ‘../gcc-2.95.3/config.guess’? y
‘/usr/share/libtool/config/config.guess’ -> ‘../gcc-2.95.3/config.guess’
┌[apacal☮apacal-virtual-machine]-(~/gcc/gcc-2-build)
└> cp /usr/share/libtool/config/config.sub ../gcc-2.95.3
cp: overwrite ‘../gcc-2.95.3/config.sub’? y
‘/usr/share/libtool/config/config.sub’ -> ‘../gcc-2.95.3/config.sub’
┌[apacal☮apacal-virtual-machine]-(~/gcc/gcc-2-build)
└> ../gcc-2.95.3/configure --prefix=/opt/gcc-2.95.3 \
    --enable-shared --enable-languages=c \
    --enable-threads=posix --enable-shared --enable-static
  ~~~

then
~~~
make bzImage && make modules
sudo make modules_install
sudo make install
~~~

now you can see ~~~sudo vim /boot/grub/menu.lst~~~
~~~
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/VolGroup00/LogVol00
#          initrd /initrd-version.img
#boot=/dev/sda
default=1
timeout=5
splashimage=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
title CentOS (2.6.19-default)
    root (hd0,0)
    kernel /vmlinuz-2.6.19-default ro root=/dev/VolGroup00/LogVol00 rhgb quiet
    initrd /initrd-2.6.19-default.img
title CentOS (2.6.18-8.el5)
    root (hd0,0)
    kernel /vmlinuz-2.6.18-8.el5 ro root=/dev/VolGroup00/LogVol00 rhgb quiet
    initrd /initrd-2.6.18-8.el5.img
~~~

~~~2.6.19-default~~~ is the kernel that our install

then reboot ~~~sudo shutdown -r now~~~ to select the kernel that we installed.

## Reference
[CustomKernel- https://wiki.centos.org/zh/HowTos/Custom_Kernel](https://wiki.centos.org/zh/HowTos/Custom_Kernel)
